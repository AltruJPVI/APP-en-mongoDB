{
  "info": {
    "name": "Tennis API - Complete Flow",
    "description": "Automatized collection",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "1. AUTH - Register User",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 201 || pm.response.code === 200) {",
              "    const response = pm.response.json();",
              "    pm.environment.set('user_id', response._id || response.id);",
              "    pm.environment.set('user_nombre', response.nombre);",
              "    console.log('✅ User ID guardado:', pm.environment.get('user_id'));",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"nombre\": \"Juan Pérez\",\n  \"email\": \"juan@email.com\",\n  \"password\": \"1234\",\n  \"clase\": \"user\",\n  \"nivel\": \"intermedio\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/auth/register",
          "host": ["{{base_url}}"],
          "path": ["api", "auth", "register"]
        }
      }
    },
    {
      "name": "2. AUTH - Login",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const response = pm.response.json();",
              "    if (response.token) {",
              "        pm.environment.set('auth_token', response.token);",
              "        console.log('✅ Token guardado');",
              "    }",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"email\": \"juan@email.com\",\n  \"password\": \"1234\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/auth/login",
          "host": ["{{base_url}}"],
          "path": ["api", "auth", "login"]
        }
      }
    },
    {
      "name": "3. POSTS - Create Post",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 201) {",
              "    const response = pm.response.json();",
              "    pm.environment.set('post_id', response._id || response.id);",
              "    console.log('✅ Post ID guardado:', pm.environment.get('post_id'));",
              "}"
            ]
          }
        },
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              "// Auto-rellenar autor_id y autor_nombre",
              "const userId = pm.environment.get('user_id');",
              "const userName = pm.environment.get('user_nombre');",
              "",
              "if (userId && userName) {",
              "    const body = JSON.parse(pm.request.body.raw);",
              "    body.autor_id = userId;",
              "    body.autor_nombre = userName;",
              "    pm.request.body.raw = JSON.stringify(body, null, 2);",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"autor_id\": \"{{user_id}}\",\n  \"autor_nombre\": \"{{user_nombre}}\",\n  \"tipo\": \"discusion\",\n  \"categoria\": \"tecnica\",\n  \"titulo\": \"¿Cómo mejorar el revés?\",\n  \"contenido\": \"Llevo tiempo practicando pero soy muy malo. ¿Qué hago?\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/posts",
          "host": ["{{base_url}}"],
          "path": ["api", "posts"]
        }
      }
    },
    {
      "name": "4. POSTS - Get Post",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/api/posts/{{post_id}}",
          "host": ["{{base_url}}"],
          "path": ["api", "posts", "{{post_id}}"]
        }
      }
    },
    {
      "name": "5. POSTS - Update Post",
      "request": {
        "method": "PUT",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"usuario_id\": \"{{user_id}}\",\n  \"titulo\": \"Ya he mejorado mi revés\",\n  \"categoria\": \"partidos\",\n  \"contenido\": \"Ya he mejorado mucho. Mañana voy al tenis de 8 a 10 ¿Quién se viene?\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/posts/{{post_id}}",
          "host": ["{{base_url}}"],
          "path": ["api", "posts", "{{post_id}}"]
        }
      }
    },
    {
      "name": "6. POSTS - Like Post",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"usuario_id\": \"{{user_id}}\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/posts/{{post_id}}/like",
          "host": ["{{base_url}}"],
          "path": ["api", "posts", "{{post_id}}", "like"]
        }
      }
    },
    {
      "name": "7. COMMENTS - Create Comment",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 201) {",
              "    const response = pm.response.json();",
              "    pm.environment.set('comment_id', response._id || response.id);",
              "    console.log('✅ Comment ID guardado:', pm.environment.get('comment_id'));",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"entidad_tipo\": \"post\",\n  \"entidad_id\": \"{{post_id}}\",\n  \"usuario_id\": \"{{user_id}}\",\n  \"usuario_nombre\": \"{{user_nombre}}\",\n  \"texto\": \"As no one answers, I myself, will play the tennis match with myself\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/comentarios",
          "host": ["{{base_url}}"],
          "path": ["api", "comentarios"]
        }
      }
    },
    {
      "name": "8. COMMENTS - Get Comment",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/api/comentarios/{{comment_id}}",
          "host": ["{{base_url}}"],
          "path": ["api", "comentarios", "{{comment_id}}"]
        }
      }
    },
    {
      "name": "9. COMMENTS - List Comments by Entity",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/api/comentarios?entidad_tipo=post&entidad_id={{post_id}}&page=1&limit=20&sort=date&order=desc",
          "host": ["{{base_url}}"],
          "path": ["api", "comentarios"],
          "query": [
            {
              "key": "entidad_tipo",
              "value": "post"
            },
            {
              "key": "entidad_id",
              "value": "{{post_id}}"
            },
            {
              "key": "page",
              "value": "1"
            },
            {
              "key": "limit",
              "value": "20"
            },
            {
              "key": "sort",
              "value": "date"
            },
            {
              "key": "order",
              "value": "desc"
            }
          ]
        }
      }
    }
  ],
  "variable": [
    {
      "key": "base_url",
      "value": "http://localhost:5000",
      "type": "string"
    }
  ]
}
