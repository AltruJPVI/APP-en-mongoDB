{
  "info": {
    "name": "Tennis API - Orders",
    "description": "Automated collection for creating orders - from viewing products to completing purchases",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "1. AUTH - Register User",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 201 || pm.response.code === 200) {",
              "    const response = pm.response.json();",
              "    console.log('üì¶ Response:', JSON.stringify(response, null, 2));",
              "    ",
              "    const user = response.user || response;",
              "    const userId = user.id || user._id;",
              "    const userName = user.nombre;",
              "    ",
              "    if (userId) {",
              "        pm.environment.set('user_id', userId);",
              "        console.log('‚úÖ User ID saved:', userId);",
              "    }",
              "    ",
              "    if (userName) {",
              "        pm.environment.set('user_nombre', userName);",
              "        console.log('‚úÖ User name saved:', userName);",
              "    }",
              "} else {",
              "    console.error('‚ùå Error in registration:', pm.response.code);",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"nombre\": \"John Doe\",\n  \"email\": \"john.doe@email.com\",\n  \"password\": \"1234\",\n  \"clase\": \"user\",\n  \"nivel\": \"intermedio\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/auth/register",
          "host": ["{{base_url}}"],
          "path": ["api", "auth", "register"]
        },
        "description": "Register a new user and save their ID and name in variables"
      }
    },
    {
      "name": "2. AUTH - Login",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const response = pm.response.json();",
              "    const user = response.user;",
              "    ",
              "    if (user && user.id) {",
              "        pm.environment.set('user_id', user.id);",
              "        pm.environment.set('user_nombre', user.nombre);",
              "        console.log('‚úÖ User ID saved:', user.id);",
              "        console.log('‚úÖ User name saved:', user.nombre);",
              "    }",
              "    ",
              "    if (response.token) {",
              "        pm.environment.set('auth_token', response.token);",
              "        console.log('‚úÖ Token saved');",
              "    }",
              "} else {",
              "    console.error('‚ùå Error in login:', pm.response.code);",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"email\": \"john.doe@email.com\",\n  \"password\": \"1234\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/auth/login",
          "host": ["{{base_url}}"],
          "path": ["api", "auth", "login"]
        },
        "description": "Login and update user_id and user_nombre variables"
      }
    },
    {
      "name": "3. PRODUCTS - List Products",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const response = pm.response.json();",
              "    console.log('üì¶ Response:', JSON.stringify(response, null, 2));",
              "    ",
              "    // Get first product from the list",
              "    const products = response.productos || response.products || response;",
              "    ",
              "    if (Array.isArray(products) && products.length > 0) {",
              "        const firstProduct = products[0];",
              "        const productId = firstProduct.id || firstProduct._id;",
              "        const productName = firstProduct.nombre || firstProduct.name;",
              "        const productPrice = firstProduct.precio || firstProduct.price;",
              "        const productStock = firstProduct.stock;",
              "        ",
              "        if (productId) {",
              "            pm.environment.set('product_id', productId);",
              "            console.log('‚úÖ Product ID saved:', productId);",
              "        }",
              "        if (productName) {",
              "            pm.environment.set('product_nombre', productName);",
              "            console.log('‚úÖ Product name saved:', productName);",
              "        }",
              "        if (productPrice) {",
              "            pm.environment.set('product_precio', productPrice);",
              "            console.log('‚úÖ Product price saved:', productPrice);",
              "        }",
              "        if (productStock !== undefined) {",
              "            pm.environment.set('stock_inicial', productStock);",
              "            console.log('‚úÖ Initial stock saved:', productStock);",
              "        }",
              "        ",
              "        // Save second product if available",
              "        if (products.length > 1) {",
              "            const secondProduct = products[1];",
              "            const productId2 = secondProduct.id || secondProduct._id;",
              "            const productName2 = secondProduct.nombre || secondProduct.name;",
              "            const productPrice2 = secondProduct.precio || secondProduct.price;",
              "            ",
              "            if (productId2) {",
              "                pm.environment.set('product_id_2', productId2);",
              "                console.log('‚úÖ Second Product ID saved:', productId2);",
              "            }",
              "            if (productName2) {",
              "                pm.environment.set('product_nombre_2', productName2);",
              "                console.log('‚úÖ Second Product name saved:', productName2);",
              "            }",
              "            if (productPrice2) {",
              "                pm.environment.set('product_precio_2', productPrice2);",
              "                console.log('‚úÖ Second Product price saved:', productPrice2);",
              "            }",
              "        }",
              "    } else {",
              "        console.error('‚ùå No products found in response');",
              "    }",
              "} else {",
              "    console.error('‚ùå Error getting products:', pm.response.code);",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/api/productos?categoria=raquetas&genero=unisex&precio_min=50&precio_max=200&page=1&limit=20",
          "host": ["{{base_url}}"],
          "path": ["api", "productos"],
          "query": [
            {
              "key": "categoria",
              "value": "raquetas"
            },
            {
              "key": "genero",
              "value": "unisex"
            },
            {
              "key": "precio_min",
              "value": "50"
            },
            {
              "key": "precio_max",
              "value": "200"
            },
            {
              "key": "page",
              "value": "1"
            },
            {
              "key": "limit",
              "value": "20"
            }
          ]
        },
        "description": "Get available products and save first product info"
      }
    },
    {
      "name": "4. PRODUCTS - Get Product Details",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const response = pm.response.json();",
              "    console.log('üì¶ Product details:', JSON.stringify(response, null, 2));",
              "    ",
              "    const product = response.producto || response.product || response;",
              "    const stock = product.stock;",
              "    ",
              "    if (stock !== undefined) {",
              "        pm.environment.set('stock_inicial', stock);",
              "        console.log('‚úÖ Initial stock updated:', stock);",
              "    }",
              "} else {",
              "    console.error('‚ùå Error getting product details:', pm.response.code);",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/api/productos/{{product_id}}",
          "host": ["{{base_url}}"],
          "path": ["api", "productos", "{{product_id}}"]
        },
        "description": "Get detailed information of a specific product including stock"
      }
    },
    {
      "name": "5. CART - Add First Product",
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              "const userId = pm.environment.get('user_id');",
              "const productId = pm.environment.get('product_id');",
              "",
              "console.log('üîç Checking variables before request:');",
              "console.log('   user_id:', userId || '‚ùå NOT DEFINED');",
              "console.log('   product_id:', productId || '‚ùå NOT DEFINED');",
              "",
              "if (!userId || !productId) {",
              "    console.error('‚ùå ERROR: Run \"1. AUTH - Register User\" and \"3. PRODUCTS - List Products\" first');",
              "    throw new Error('Variables user_id or product_id are not defined.');",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"id_producto\": \"{{product_id}}\",\n  \"nombre\": \"{{product_nombre}}\",\n  \"precio\": {{product_precio}},\n  \"cantidad\": 2\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/usuarios/{{user_id}}/carrito",
          "host": ["{{base_url}}"],
          "path": ["api", "usuarios", "{{user_id}}", "carrito"]
        },
        "description": "Add first product to cart"
      }
    },
    {
      "name": "6. CART - Add Second Product (Optional)",
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              "const productId2 = pm.environment.get('product_id_2');",
              "",
              "if (!productId2) {",
              "    console.log('‚ö†Ô∏è  No second product available. Skipping this step or manually set product_id_2, product_nombre_2, and product_precio_2 variables.');",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"id_producto\": \"{{product_id_2}}\",\n  \"nombre\": \"{{product_nombre_2}}\",\n  \"precio\": {{product_precio_2}},\n  \"cantidad\": 1\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/usuarios/{{user_id}}/carrito",
          "host": ["{{base_url}}"],
          "path": ["api", "usuarios", "{{user_id}}", "carrito"]
        },
        "description": "Add a second product to cart (optional step - uses second product from product list)"
      }
    },
    {
      "name": "7. CART - View Cart",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/api/usuarios/{{user_id}}/carrito",
          "host": ["{{base_url}}"],
          "path": ["api", "usuarios", "{{user_id}}", "carrito"]
        },
        "description": "View the shopping cart contents"
      }
    },
    {
      "name": "8. USER - Get User Profile",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/api/usuarios/{{user_id}}",
          "host": ["{{base_url}}"],
          "path": ["api", "usuarios", "{{user_id}}"]
        },
        "description": "Get complete user profile including cart"
      }
    },
    {
      "name": "9. ORDERS - Create Order",
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              "const userId = pm.environment.get('user_id');",
              "const productId = pm.environment.get('product_id');",
              "const productId2 = pm.environment.get('product_id_2');",
              "",
              "console.log('üîç Checking variables before request:');",
              "console.log('   user_id:', userId || '‚ùå NOT DEFINED');",
              "console.log('   product_id:', productId || '‚ùå NOT DEFINED');",
              "console.log('   product_id_2:', productId2 || '‚ùå NOT DEFINED');",
              "",
              "if (!userId || !productId) {",
              "    console.error('‚ùå ERROR: Run authentication and product steps first');",
              "    throw new Error('Variables user_id or product_id are not defined.');",
              "}",
              "",
              "if (!productId2) {",
              "    console.log('‚ö†Ô∏è  WARNING: product_id_2 not defined. Make sure you ran step 6 (Add Second Product)');",
              "    console.log('‚ö†Ô∏è  The order will include both products from your cart');",
              "}",
              "",
              "console.log('‚ö†Ô∏è  IMPORTANT: Verify the total matches the sum of your cart items');",
              "console.log('‚ö†Ô∏è  Current order total in body: 444.98 (adjust if needed)');"
            ]
          }
        },
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 201 || pm.response.code === 200) {",
              "    const response = pm.response.json();",
              "    console.log('üì¶ Response:', JSON.stringify(response, null, 2));",
              "    ",
              "    const order = response.pedido || response.order || response;",
              "    const orderId = order.id || order._id;",
              "    ",
              "    if (orderId) {",
              "        pm.environment.set('order_id', orderId);",
              "        console.log('‚úÖ Order ID saved:', orderId);",
              "    }",
              "} else {",
              "    console.error('‚ùå Error creating order:', pm.response.code);",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"user_id\": \"{{user_id}}\",\n  \"items\": [\n    {\n      \"id_producto\": \"{{product_id}}\",\n      \"nombre\": \"{{product_nombre}}\",\n      \"precio\": {{product_precio}},\n      \"cantidad\": 2\n    },\n    {\n      \"id_producto\": \"{{product_id_2}}\",\n      \"nombre\": \"{{product_nombre_2}}\",\n      \"precio\": {{product_precio_2}},\n      \"cantidad\": 1\n    }\n  ],\n  \"total\": 444.98,\n  \"direccion_envio\": {\n    \"calle\": \"Calle Mayor 123\",\n    \"ciudad\": \"Madrid\",\n    \"codigo_postal\": \"28001\",\n    \"telefono\": \"612345678\"\n  },\n  \"metodo_pago\": \"tarjeta\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/pedidos",
          "host": ["{{base_url}}"],
          "path": ["api", "pedidos"]
        },
        "description": "Create an order with cart items - ACID transaction (creates order, reduces stock, empties cart)"
      }
    },
    {
      "name": "10. ORDERS - Get User Orders",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/api/pedidos/usuario/{{user_id}}?page=1&limit=20",
          "host": ["{{base_url}}"],
          "path": ["api", "pedidos", "usuario", "{{user_id}}"],
          "query": [
            {
              "key": "page",
              "value": "1"
            },
            {
              "key": "limit",
              "value": "20"
            }
          ]
        },
        "description": "Get all orders for the user"
      }
    },
    {
      "name": "11. CART - Check Empty Cart",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/api/usuarios/{{user_id}}/carrito",
          "host": ["{{base_url}}"],
          "path": ["api", "usuarios", "{{user_id}}", "carrito"]
        },
        "description": "Verify that cart is empty after creating the order"
      }
    },
    {
      "name": "12. PRODUCTS - Verify Stock Decreased",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const response = pm.response.json();",
              "    const product = response.producto || response.product || response;",
              "    const currentStock = product.stock;",
              "    const initialStock = pm.environment.get('stock_inicial');",
              "    ",
              "    console.log('üìä Stock comparison:');",
              "    console.log('   Initial stock:', initialStock);",
              "    console.log('   Current stock:', currentStock);",
              "    ",
              "    if (initialStock && currentStock !== undefined) {",
              "        const difference = initialStock - currentStock;",
              "        console.log('   Stock decreased by:', difference);",
              "        ",
              "        if (difference > 0) {",
              "            console.log('‚úÖ Stock successfully decreased after order');",
              "        } else {",
              "            console.log('‚ö†Ô∏è  Stock did not decrease - check order creation');",
              "        }",
              "    }",
              "} else {",
              "    console.error('‚ùå Error getting product:', pm.response.code);",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/api/productos/{{product_id}}",
          "host": ["{{base_url}}"],
          "path": ["api", "productos", "{{product_id}}"]
        },
        "description": "Check product again to verify stock has decreased"
      }
    }
  ]
}