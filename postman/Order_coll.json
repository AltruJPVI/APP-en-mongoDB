{
  "info": {
    "name": "Tennis API - Orders",
    "description": "Automated collection for creating orders - from viewing products to completing purchases",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "1. AUTH - Register User",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 201 || pm.response.code === 200) {",
              "    const response = pm.response.json();",
              "    console.log('üì¶ Response:', JSON.stringify(response, null, 2));",
              "    ",
              "    const user = response.user || response;",
              "    const userId = user.id || user._id;",
              "    const userName = user.name;",
              "    ",
              "    if (userId) {",
              "        pm.environment.set('user_id', userId);",
              "        console.log('‚úÖ User ID saved:', userId);",
              "    }",
              "    ",
              "    if (userName) {",
              "        pm.environment.set('user_name', userName);",
              "        console.log('‚úÖ User name saved:', userName);",
              "    }",
              "} else {",
              "    console.error('‚ùå Error in registration:', pm.response.code);",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"name\": \"John Doe\",\n  \"email\": \"john.doe@email.com\",\n  \"password\": \"1234\",\n  \"role\": \"user\",\n  \"level\": \"intermediate\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/auth/register",
          "host": ["{{base_url}}"],
          "path": ["api", "auth", "register"]
        },
        "description": "Register a new user and save their ID and name in variables"
      }
    },
    {
      "name": "2. AUTH - Login",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const response = pm.response.json();",
              "    const user = response.user;",
              "    ",
              "    if (user && user.id) {",
              "        pm.environment.set('user_id', user.id);",
              "        pm.environment.set('user_name', user.name);",
              "        console.log('‚úÖ User ID saved:', user.id);",
              "        console.log('‚úÖ User name saved:', user.name);",
              "    }",
              "    ",
              "    if (response.token) {",
              "        pm.environment.set('auth_token', response.token);",
              "        console.log('‚úÖ Token saved');",
              "    }",
              "} else {",
              "    console.error('‚ùå Error in login:', pm.response.code);",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"email\": \"john.doe@email.com\",\n  \"password\": \"1234\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/auth/login",
          "host": ["{{base_url}}"],
          "path": ["api", "auth", "login"]
        },
        "description": "Login and update user_id and user_name variables"
      }
    },
    {
      "name": "3. PRODUCTS - List Products",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const response = pm.response.json();",
              "    console.log('üì¶ Response:', JSON.stringify(response, null, 2));",
              "    ",
              "    // Get first product from the list",
              "    const products = response.products || response;",
              "    ",
              "    if (Array.isArray(products) && products.length > 0) {",
              "        const firstProduct = products[0];",
              "        const productId = firstProduct.id || firstProduct._id;",
              "        const productName = firstProduct.name;",
              "        const productPrice = firstProduct.price;",
              "        const productStock = firstProduct.stock;",
              "        ",
              "        if (productId) {",
              "            pm.environment.set('product_id', productId);",
              "            console.log('‚úÖ Product ID saved:', productId);",
              "        }",
              "        if (productName) {",
              "            pm.environment.set('product_name', productName);",
              "            console.log('‚úÖ Product name saved:', productName);",
              "        }",
              "        if (productPrice) {",
              "            pm.environment.set('product_price', productPrice);",
              "            console.log('‚úÖ Product price saved:', productPrice);",
              "        }",
              "        if (productStock !== undefined) {",
              "            pm.environment.set('initial_stock', productStock);",
              "            console.log('‚úÖ Initial stock saved:', productStock);",
              "        }",
              "        ",
              "        // Save second product if available",
              "        if (products.length > 1) {",
              "            const secondProduct = products[1];",
              "            const productId2 = secondProduct.id || secondProduct._id;",
              "            const productName2 = secondProduct.name;",
              "            const productPrice2 = secondProduct.price;",
              "            ",
              "            if (productId2) {",
              "                pm.environment.set('product_id_2', productId2);",
              "                console.log('‚úÖ Second Product ID saved:', productId2);",
              "            }",
              "            if (productName2) {",
              "                pm.environment.set('product_name_2', productName2);",
              "                console.log('‚úÖ Second Product name saved:', productName2);",
              "            }",
              "            if (productPrice2) {",
              "                pm.environment.set('product_price_2', productPrice2);",
              "                console.log('‚úÖ Second Product price saved:', productPrice2);",
              "            }",
              "        }",
              "    } else {",
              "        console.error('‚ùå No products found in response');",
              "    }",
              "} else {",
              "    console.error('‚ùå Error getting products:', pm.response.code);",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/api/products?category=rackets&gender=unisex&price_min=50&price_max=200&page=1&limit=20",
          "host": ["{{base_url}}"],
          "path": ["api", "products"],
          "query": [
            {
              "key": "category",
              "value": "rackets"
            },
            {
              "key": "gender",
              "value": "unisex"
            },
            {
              "key": "price_min",
              "value": "50"
            },
            {
              "key": "price_max",
              "value": "200"
            },
            {
              "key": "page",
              "value": "1"
            },
            {
              "key": "limit",
              "value": "20"
            }
          ]
        },
        "description": "Get available products and save first product info"
      }
    },
    {
      "name": "4. PRODUCTS - Get Product Details",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const response = pm.response.json();",
              "    console.log('üì¶ Product details:', JSON.stringify(response, null, 2));",
              "    ",
              "    const product = response.product || response;",
              "    const stock = product.stock;",
              "    ",
              "    if (stock !== undefined) {",
              "        pm.environment.set('initial_stock', stock);",
              "        console.log('‚úÖ Initial stock updated:', stock);",
              "    }",
              "} else {",
              "    console.error('‚ùå Error getting product details:', pm.response.code);",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/api/products/{{product_id}}",
          "host": ["{{base_url}}"],
          "path": ["api", "products", "{{product_id}}"]
        },
        "description": "Get detailed information of a specific product including stock"
      }
    },
    {
      "name": "5. CART - Add First Product",
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              "const userId = pm.environment.get('user_id');",
              "const productId = pm.environment.get('product_id');",
              "",
              "console.log('üîç Checking variables before request:');",
              "console.log('   user_id:', userId || '‚ùå NOT DEFINED');",
              "console.log('   product_id:', productId || '‚ùå NOT DEFINED');",
              "",
              "if (!userId || !productId) {",
              "    console.error('‚ùå ERROR: Run \"1. AUTH - Register User\" and \"3. PRODUCTS - List Products\" first');",
              "    throw new Error('Variables user_id or product_id are not defined.');",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"product_id\": \"{{product_id}}\",\n  \"name\": \"{{product_name}}\",\n  \"price\": {{product_price}},\n  \"quantity\": 2\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/users/{{user_id}}/cart",
          "host": ["{{base_url}}"],
          "path": ["api", "users", "{{user_id}}", "cart"]
        },
        "description": "Add first product to cart"
      }
    },
    {
      "name": "6. CART - Add Second Product (Optional)",
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              "const productId2 = pm.environment.get('product_id_2');",
              "",
              "if (!productId2) {",
              "    console.log('‚ö†Ô∏è  No second product available. Skipping this step or manually set product_id_2, product_name_2, and product_price_2 variables.');",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"product_id\": \"{{product_id_2}}\",\n  \"name\": \"{{product_name_2}}\",\n  \"price\": {{product_price_2}},\n  \"quantity\": 1\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/users/{{user_id}}/cart",
          "host": ["{{base_url}}"],
          "path": ["api", "users", "{{user_id}}", "cart"]
        },
        "description": "Add a second product to cart (optional step - uses second product from product list)"
      }
    },
    {
      "name": "7. CART - View Cart",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/api/users/{{user_id}}/cart",
          "host": ["{{base_url}}"],
          "path": ["api", "users", "{{user_id}}", "cart"]
        },
        "description": "View the shopping cart contents"
      }
    },
    {
      "name": "8. USER - Get User Profile",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/api/users/{{user_id}}",
          "host": ["{{base_url}}"],
          "path": ["api", "users", "{{user_id}}"]
        },
        "description": "Get complete user profile including cart"
      }
    },
    {
      "name": "9. ORDERS - Create Order",
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              "const userId = pm.environment.get('user_id');",
              "const productId = pm.environment.get('product_id');",
              "const productId2 = pm.environment.get('product_id_2');",
              "",
              "console.log('üîç Checking variables before request:');",
              "console.log('   user_id:', userId || '‚ùå NOT DEFINED');",
              "console.log('   product_id:', productId || '‚ùå NOT DEFINED');",
              "console.log('   product_id_2:', productId2 || '‚ùå NOT DEFINED');",
              "",
              "if (!userId || !productId) {",
              "    console.error('‚ùå ERROR: Run authentication and product steps first');",
              "    throw new Error('Variables user_id or product_id are not defined.');",
              "}",
              "",
              "if (!productId2) {",
              "    console.log('‚ö†Ô∏è  WARNING: product_id_2 not defined. Make sure you ran step 6 (Add Second Product)');",
              "    console.log('‚ö†Ô∏è  The order will include both products from your cart');",
              "}",
              "",
              "console.log('‚ö†Ô∏è  IMPORTANT: Verify the total matches the sum of your cart items');",
              "console.log('‚ö†Ô∏è  Current order total in body: 444.98 (adjust if needed)');"
            ]
          }
        },
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 201 || pm.response.code === 200) {",
              "    const response = pm.response.json();",
              "    console.log('üì¶ Response:', JSON.stringify(response, null, 2));",
              "    ",
              "    const order = response.order || response;",
              "    const orderId = order.id || order._id;",
              "    ",
              "    if (orderId) {",
              "        pm.environment.set('order_id', orderId);",
              "        console.log('‚úÖ Order ID saved:', orderId);",
              "    }",
              "} else {",
              "    console.error('‚ùå Error creating order:', pm.response.code);",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"user_id\": \"{{user_id}}\",\n  \"items\": [\n    {\n      \"product_id\": \"{{product_id}}\",\n      \"name\": \"{{product_name}}\",\n      \"price\": {{product_price}},\n      \"quantity\": 2\n    },\n    {\n      \"product_id\": \"{{product_id_2}}\",\n      \"name\": \"{{product_name_2}}\",\n      \"price\": {{product_price_2}},\n      \"quantity\": 1\n    }\n  ],\n  \"total\": 444.98,\n  \"shipping_address\": {\n    \"street\": \"Main Street 123\",\n    \"city\": \"Madrid\",\n    \"postal_code\": \"28001\",\n    \"phone\": \"612345678\"\n  },\n  \"payment_method\": \"card\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/orders",
          "host": ["{{base_url}}"],
          "path": ["api", "orders"]
        },
        "description": "Create an order with cart items - ACID transaction (creates order, reduces stock, empties cart)"
      }
    },
{
  "name": "10. ORDERS - Get Order Details",
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "exec": [
          "const orderId = pm.environment.get('order_id');",
          "",
          "console.log('üîç Checking variables before request:');",
          "console.log('   order_id:', orderId || '‚ùå NOT DEFINED');",
          "",
          "if (!orderId) {",
          "    console.error('‚ùå ERROR: Run \"9. ORDERS - Create Order\" first');",
          "    throw new Error('Variable order_id is not defined.');",
          "}"
        ]
      }
    },
    {
      "listen": "test",
      "script": {
        "exec": [
          "if (pm.response.code === 200) {",
          "    const response = pm.response.json();",
          "    console.log('üì¶ Order details:', JSON.stringify(response, null, 2));",
          "    console.log('‚úÖ Order retrieved successfully');",
          "} else {",
          "    console.error('‚ùå Error getting order:', pm.response.code);",
          "}"
        ]
      }
    }
  ],
  "request": {
    "method": "GET",
    "header": [],
    "url": {
      "raw": "{{base_url}}/api/orders/{{order_id}}",
      "host": ["{{base_url}}"],
      "path": ["api", "orders", "{{order_id}}"]
    },
    "description": "Get the order details by ID to verify it was created correctly"
  }
},
    {
      "name": "11. CART - Check Empty Cart",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/api/users/{{user_id}}/cart",
          "host": ["{{base_url}}"],
          "path": ["api", "users", "{{user_id}}", "cart"]
        },
        "description": "Verify that cart is empty after creating the order"
      }
    },
    {
      "name": "12. PRODUCTS - Verify Stock Decreased",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const response = pm.response.json();",
              "    const product = response.product || response;",
              "    const currentStock = product.stock;",
              "    const initialStock = pm.environment.get('initial_stock');",
              "    ",
              "    console.log('üìä Stock comparison:');",
              "    console.log('   Initial stock:', initialStock);",
              "    console.log('   Current stock:', currentStock);",
              "    ",
              "    if (initialStock && currentStock !== undefined) {",
              "        const difference = initialStock - currentStock;",
              "        console.log('   Stock decreased by:', difference);",
              "        ",
              "        if (difference > 0) {",
              "            console.log('‚úÖ Stock successfully decreased after order');",
              "        } else {",
              "            console.log('‚ö†Ô∏è  Stock did not decrease - check order creation');",
              "        }",
              "    }",
              "} else {",
              "    console.error('‚ùå Error getting product:', pm.response.code);",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/api/products/{{product_id}}",
          "host": ["{{base_url}}"],
          "path": ["api", "products", "{{product_id}}"]
        },
        "description": "Check product again to verify stock has decreased"
      }
    }
  ]
}